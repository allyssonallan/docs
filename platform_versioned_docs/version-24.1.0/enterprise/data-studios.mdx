---
title: "Data Studios deployment"
description: Deploy Seqera Platform with Data studios
date: "12 Jun 2024"
tags: [docker, compose, kubernetes, data, studios, deployment]
---

You can enable Data Studios as part of your Seqera Platform instance.

## DNS configuration

Each data studio is reachable at a unique URL, which includes a randomly generated subdomain name. For example, a data studio URL can be: `https://abcd.example.com/`, where `example.com` is your Seqera base domain name.

To allow for uniquely generated third level domains, you must provide a wildcard TLS certificate. A wildcard certificate is one where the common name includes `*.` in the domain name, such as `*.example.com`.

Data Studios uses the following set of domains and subdomains:

- The domain that you set for `TOWER_SERVER_URL`, such as `example.com`.
- A wildcard subdomain that you must configure specifically for Data Studios. This wildcard subdomain is the parent for each unique data studios session URL, such as `abcd.example.com`.
- The connection proxy, defined by `CONNECT_PROXY_URL`. This URL is used internally and by convention is `connect.example.com`. This domain must be a subdomain of your Platform, so you cannot use `connect.example.net` if your Platform domain is `example.com`.

:::note
We recommend using only a third-level domain to minimize additional costs that you might incur from additional nesting of subdomains.
:::

## Docker Compose

This guide assumes that all services will be run in the same container as the rest of your Seqera Platform services.

### Prerequisites

- Allow inbound traffic to port 9090 on EC2 instance
- Allow traffic on port 9090 through AWS LB
- An RSA private key in PEM format
- An AWS Route53 wildcard DNS record, such as `*.<seqera_platform_domain>`

### Procedure

1. Download the Data Studios `data-studios.env` environment configuration file.

1. Open `data-studios.env` in an editor, and make the following changes:
   1. Uncomment the `connect-proxy` and `connect-server` services.
   1. Set the following environment variables:
      - `PLATFORM_URL`: Specify the same value assigned to `TOWER_SERVER_URL`.
      - `CONNECT_PROXY_URL`: Specify a base domain name for the connect proxy subdomain. For example, if you specify `example.com` then `connect.example.com` is the fully qualified domain name for the proxy.
      - `CONNECT_OIDC_CLIENT_REGISTRATION_TOKEN`: 

1. Edit your existing Seqera `tower.env` configuration file, and ensure that the following variables are set:

   - `TOWER_DATA_STUDIO_ALLOWED_WORKSPACES`: Enable [Data Studios](https://docs.seqera.io/platform/latest/data/data-studios) in the specified workspaces.
   - `TOWER_DATA_EXPLORER_ENABLED`: Specifies whether to enable Data Explorer. You must enable Data Explorer to mount data inside a data studio instance.
   - `TOWER_DATA_STUDIO_CONNECT_URL`: Specifies the URL of the Data Studios connect proxy, such as `https://connect.tower.example.com/`.
   - `TOWER_OIDC_REGISTRATION_INITIAL_ACCESS_TOKEN`: An access token that is used for registering new clients with Seqera Platform. Any alphanumeric value is allowed.
   - `TOWER_OIDC_PEM_PATH`: The file path to a PEM certificate that is used for signing the OIDC tokens for the OpenID connect provider.

1. Open the `docker-compose.yml`, and uncomment the volume mount for the PEM key file for the `backend` service in the `volumes` list. Your PEM file must be named `data-studios-rsa.pem`.

    ```yaml
        volumes:
          - $PWD/tower.yml:/tower.yml
          # Data studios RSA key is required for the data studios functionality. Uncomment the line below to mount the key.
          #- $PWD/data-studios-rsa.pem:/data-studios-rsa.pem
    ```

1. Start your Platform instance: `docker compose -d up`.

## Kubernetes

This procedure describes how to configure Data Studios for Kubernetes deployments of Seqera Platform.

### Procedure

1. Download the Kubernetes manifests for the Data Studios service:

    - [Ingress](./_templates/k8s/data_studios/ingress.aks.yml)
    - [Proxy config](./_templates/k8s/data_studios/proxy-config.yml)
    - [Proxy](./_templates/k8s/data_studios/proxy.yml)
    - [Server](./_templates/k8s/data_studios/server.yml)

1. Edit the `server.yml` file and set the `CONNECT_REDIS_ADDRESS` environment variable to the host name or IP address of the Redis server that you configured for Platform.

1. Edit the `proxy.yml` file and set the following variables:

    - `CONNECT_REDIS_ADDRESS`: Specify the host name or IP address of the Redis server that you configure for Platform.
    - `CONNECT_PROXY_URL`: Specify a base domain name for the connect proxy subdomain. For example, if you specify `example.com` then `connect.example.com` is the fully qualified domain name for the proxy.
    - `PLATFORM_URL`: Specifies the base URL for your Platform installation, such as `https://tower.example.com/`.

1. Change your Kubernetes context to the one where your Platform instance runs:

    ```
    kubectl config set-context --current --namespace=<namespace>
    ```

1. Create a Secret that contains the initial access token. Any alphanumeric value is allowed.

    ```yaml
    apiVersion: v1
    kind: Secret
    metadata:
      name: platform-oidc-certs
      namespace: platform-stage
    data:
      oidc.pem: <BASE64_ENCODED_SECRET>
    ```

1. Edit the ConfigMap named `platform-backend-cfg` in the `configmap.yml` for Platform.
    -  Add the following environment variables:

       - `TOWER_DATA_STUDIO_CONNECT_URL`: Specifies the URL of the Data Studios connect proxy, such as `https://connect.tower.example.com/`.
       - `TOWER_OIDC_REGISTRATION_INITIAL_ACCESS_TOKEN`: Use the same access token that you specified in the Secret named `connect-proxy-secret`.
       - `TOWER_OIDC_PEM_PATH`: The file path to a PEM certificate that is used for signing the OIDC tokens for the OpenID connect provider.

    - If you want to restrict Data Studios to specific organization workspaces, list each workspace ID in the `TOWER_DATA_STUDIO_ALLOWED_WORKSPACES`.
    - If you want to allow access to Data Studios in every organizational workspace, do not include the `TOWER_DATA_STUDIO_ALLOWED_WORKSPACES`.

1. Optional: If you want to allow access to Data Studios in every organizational workspace, edit the ConfigMap named `tower-yml` in the `configmap.yml` and include the following stanza with your existing configuration:

    ```yaml
    data:
      tower.yml: |-
        tower:
          data-studio:
            allowed-workspaces: null
    ```

1. Apply the updated configuration: `kubectl apply -f configmap.yml`
1. Apply the Data Studios manifests:

    ```
    kubectl apply -f ingress.aks.yml proxy-config.yml proxy.yml server.yml
    ```

    It can take several minutes for Kubernetes to apply your changes, during which new pods are rolled out.

1. To confirm that Data Studios is available, log in to your Platform instance and navigate to a organizational workspace for which Data Studios is enabled. The **Data Studios** tab is included with the available tabs.
