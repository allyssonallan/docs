---
title: "Data Studios deployment"
description: Deploy Seqera Platform with Data studios
date: "12 Jun 2024"
tags: [docker, compose, kubernetes, data, studios, deployment]
---

You can enable Data Studios as part of your Seqera Platform instance.

## DNS configuration

Each data studio is reachable at a unique URL, which includes a randomly generated subdomain name. For example, a data studio URL can be: `https://abcd.example.com/`, where `example.com` is your Seqera base domain name.

To allow for uniquely generated third level domains, you must provide a wildcard TLS certificate. A wildcard certificate is one where the common name includes `*.` in the domain name, such as `*.example.com`.

The proxy domain (`CONNECT_PROXY_URL`) has to be a subdomain of main platform domain (example: if the platform domain is
`tower.io`, then the proxy domain should be `example.tower.io`).
Data Studios requires a wildcard DNS record that will match requests for non-existent subdomains.
It is specified by a `*` as part of the domain name, example: `*.tower.io`. It should be pointed to the port 9090.

Example of setup:
```
*.tower.io -> 9090
tower.io -> 8000
```

```
tower.io -> tower address
connect.tower.io -> connect proxy address
ahdsyg.tower.io -> studio address
```

You must provide a valid wildcard TLS certificate for the third level domain.

:::note
We recommend using only a third-level domain if possible, as costs may increase with the number of subdomains.
:::

## Docker Compose

This guide assumes that all services will be run in the same container as the rest of your Seqera Platform services.

### Prerequisites

- Allow inbound traffic to port 9090 on EC2 instance
- Allow traffic on port 9090 through AWS LB
- An RSA private key in PEM format
- An AWS Route53 wildcard DNS record, such as `*.<seqera_platform_domain>`

### Procedure

1. Download the Data Studios `data-studios.env` environment configuration file.

1. Open `data-studios.env` in an editor, and make the following changes:
   1. Uncomment the `connect-proxy` and `connect-server` services.
   1. Set the following environment variables:
      - `PLATFORM_URL`
      - `CONNECT_PROXY_URL`
      - `CONNECT_OIDC_CLIENT_REGISTRATION_TOKEN`

1. Edit your existing Seqera `tower.env` configuration file, and ensure that the following variables are set:

   - `TOWER_DATA_STUDIO_ALLOWED_WORKSPACES`
   - `TOWER_DATA_EXPLORER_ENABLED`
   - `TOWER_DATA_STUDIO_CONNECT_URL`
   - `TOWER_OIDC_REGISTRATION_INITIAL_ACCESS_TOKEN`
   - `TOWER_OIDC_PEM_PATH`

1. Open the `docker-compose.yml`, and uncomment the volume mount for the PEM key file for the `backend` service in the `volumes` list:

    ```yaml
        volumes:
          - $PWD/tower.yml:/tower.yml
          # Data studios RSA key is required for the data studios functionality. Uncomment the line below to mount the key.
          #- $PWD/data-studios-rsa.pem:/data-studios-rsa.pem
    ```

1. Start your Platform instance: `docker compose -d up`.

## Kubernetes

This procedure describes how to configure Data Studios for Kubernetes deployments of Seqera Platform.

### Procedure

1. Download the Kubernetes manifests for the Data Studios service:

    - [Ingress](./_templates/k8s/data_studios/ingress.aks.yml)
    - [Proxy config](./_templates/k8s/data_studios/proxy-config.yml)
    - [Proxy](./_templates/k8s/data_studios/proxy.yml)
    - [Server](./_templates/k8s/data_studios/server.yml)

1. Edit the `server.yml` file and set the `REDIS_ADDRESS` environment variable to the host name or IP address of the Redis server that you configured for Platform.

1. Edit the `proxy.yml` file and set the following variables:

    - `REDIS_SERVER`
    - `TOWER_CONNECT_DOMAIN`
    - `TOWER_BASE_URL`

1. Change your Kubernetes context to the one where your Platform instance runs:

    ```
    kubectl config set-context --current --namespace=<namespace>
    ```

1. Create a Secret that contains the initial access token. Any alphanumeric value is allowed.

    ```yaml
    apiVersion: v1
    kind: Secret
    type: Opaque
    metadata:
      name: connect-proxy-secret
      namespace: connect-stage
    stringData:
      INITIAL_ACCESS_TOKEN: <INITIAL_ACCESS_TOKEN>
    ```

1. Edit the ConfigMap named `platform-backend-cfg` in the `configmap.yml` for Platform.
    -  Add the following environment variables:

       - `TOWER_DATA_STUDIO_CONNECT_URL`
       - `TOWER_OIDC_REGISTRATION_INITIAL_ACCESS_TOKEN`: Use the same access token that you specified in the previous step
       - `TOWER_OIDC_PEM_PATH`

    - If you want to restrict Data Studios to specific organization workspaces, list each workspace ID in the `TOWER_DATA_STUDIO_ALLOWED_WORKSPACES`.
    - If you want to allow access to Data Studios in every organizational workspace, do not include the `TOWER_DATA_STUDIO_ALLOWED_WORKSPACES`.

1. Optional: If you want to allow access to Data Studios in every organizational workspace, edit the ConfigMap named `tower-yml` in the `configmap.yml` and include the following stanza with your existing configuration:

    ```yaml
    data:
      tower.yml: |-
        tower:
          data-studio:
            allowed-workspaces: null
    ```

1. Apply the updated configuration: `kubectl apply -f configmap.yml`
1. Apply the Data Studios manifests:

    ```
    kubectl apply -f ingress.aks.yml proxy-config.yml proxy.yml server.yml
    ```

### Parking

---

To run Data Studios in `docker compose` setup uncomment following values in the `_templates/docker/tower.env` file:

# Data studios settings
```yaml
TOWER_BASE_URL=<YOUR TOWER URL, IDENTICAL AS `TOWER_SERVER_URL` in `tower.env`>
CONNECT_HTTP_PORT=9090
TOWER_CONNECT_ADDRESS=connect-proxy:9090
TOWER_CONNECT_TUNNEL=connect-server:7070
REDIS_ADDRESS: redis:6379
CONNECT_PROXY_URL=<YOUR CONNECT URL, It has to be a subdomain of your tower domain, example: https://connect.tower.io >
INITIAL_ACCESS_TOKEN=<YOUR INITIAL ACCESS TOKEN, IDEANTICAL AS `TOWER_OIDC_REGISTRATION_INITIAL_ACCESS_TOKEN` in `tower.env`>
```

```dotenv
# Data Studios settings
TOWER_DATA_STUDIO_ALLOWED_WORKSPACES=<ALLOWED WORKSPACES>

# Enable Data Explorer to enable mounting data to your data studios
TOWER_DATA_EXPLORER_ENABLED=true
TOWER_DATA_EXPLORER_CLOUD_DISABLED_WORKSPACES=

TOWER_DATA_STUDIO_ALLOWED_WORKSPACES=<ALLOWED WORKSPACES>
TOWER_DATA_STUDIO_CONNECT_URL=<YOUR CONNECT URL, SAME AS `CONNECT_PROXY_URL` IN `data-studios.env` >
TOWER_OIDC_REGISTRATION_INITIAL_ACCESS_TOKEN=<YOUR INITIAL ACCESS TOKEN, IDENTICAL AS `INITIAL_ACCESS_TOKEN` in `data-studios.env`>
TOWER_OIDC_PEM_PATH=<PATH TO PEM FILE>
```

Fill in the values for `_templates/docker/data-studios.env` and uncomment the following lines in the `_templates/docker/docker-compose.yml` file:

```yaml
  connect-proxy:
    image: cr.seqera.io/private/nf-tower-enterprise/data-studio/tower-connect-proxy:0.6.14
    platform: linux/amd64
    env_file:
      - data-studios.env
    networks:
      - frontend
      - backend
    ports:
      - 9090:9090
    restart: always
    depends_on:
      - redis

  connect-server:
    image: cr.seqera.io/private/nf-tower-enterprise/data-studio/tower-connect-server:v0.6.14
    platform: linux/amd64
    env_file:
      - data-studios.env
    networks:
      - backend
    ports:
      - 7070:7070
    restart: always
```

An RSA key is required for the Data Studios functionality. Generate your key and provide the path to it in the
`TOWER_OIDC_PEM_PATH` variable in the `data-studios.env` file. Next mount the `pem` file in the `backend` service in the `docker-compose.yml` file.

See this example in the configuration with `data-studios-rsa.pem` file mounted in the `backend` service:
```yaml
  backend:
    volumes:
      - $PWD/data-studios-rsa.pem:/data-studios-rsa.pem
```
